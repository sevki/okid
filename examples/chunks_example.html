<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Chunks WASM Example</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .results {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }

        .chunk-item {
            margin: 5px 0;
            padding: 5px;
            background: white;
            border-radius: 3px;
        }

        input[type="file"],
        textarea {
            width: 100%;
            margin: 10px 0;
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 3px;
            cursor: pointer;
        }

        button:hover {
            background: #0056b3;
        }
    </style>
</head>

<body>
    <h1>Chunks WASM Async Iterator Example</h1>

    <div class="section">
        <h2>Text Chunking</h2>
        <textarea id="textInput" rows="5" placeholder="Enter text to chunk...">
Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.
        </textarea>
        <label>
            Average chunk size:
            <input type="number" id="chunkSize" value="50" min="10" max="1000">
        </label>
        <button onclick="chunkText()">Chunk Text</button>
        <div id="textResults" class="results"></div>
    </div>

    <div class="section">
        <h2>File Chunking</h2>
        <input type="file" id="fileInput">
        <button onclick="chunkFile()">Chunk File</button>
        <div id="fileResults" class="results"></div>
    </div>

    <script type="module">
        import init, { FileChunker, chunk_text } from '../pkg/chunks.js';

        await init();

        // Helper to format chunk results
        function formatChunk(chunk, index) {
            return `
                <div class="chunk-item">
                    <strong>Chunk ${index + 1}</strong><br>
                    Offset: ${chunk.offset}, Length: ${chunk.length}<br>
                    Fingerprint: ${chunk.fingerprint.toString()}<br>
                    Content Hash: ${chunk.content_hash.toString()}
                </div>
            `;
        }

        // Chunk text using async iterator
        window.chunkText = async function () {
            const text = document.getElementById('textInput').value;
            const avgSize = parseInt(document.getElementById('chunkSize').value);
            const resultsDiv = document.getElementById('textResults');

            resultsDiv.innerHTML = '<p>Chunking text...</p>';

            try {
                const iterator = chunk_text(text, avgSize);
                const chunks = [];

                // Use for-await-of with the async iterator
                for await (const chunk of iterator) {
                    chunks.push(chunk);
                }

                resultsDiv.innerHTML = `
                    <p>Found ${chunks.length} chunks:</p>
                    ${chunks.map((chunk, i) => formatChunk(chunk, i)).join('')}
                `;
            } catch (error) {
                resultsDiv.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            }
        };

        // Chunk file using async iterator
        window.chunkFile = async function () {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];

            if (!file) {
                alert('Please select a file');
                return;
            }

            const resultsDiv = document.getElementById('fileResults');
            resultsDiv.innerHTML = '<p>Chunking file...</p>';

            try {
                const chunker = new FileChunker(131072); // 128KB average chunk size
                const iterator = await chunker.chunk_file(file);

                const chunks = [];
                let totalSize = 0;

                // Use for-await-of with the async iterator
                for await (const chunk of iterator) {
                    chunks.push(chunk);
                    totalSize += chunk.length;

                    // Update progress
                    resultsDiv.innerHTML = `
                        <p>Processing... Found ${chunks.length} chunks (${(totalSize / 1024).toFixed(2)} KB processed)</p>
                    `;
                }

                // Final results
                resultsDiv.innerHTML = `
                    <p>File: ${file.name} (${(file.size / 1024).toFixed(2)} KB)</p>
                    <p>Found ${chunks.length} chunks, Total size: ${(totalSize / 1024).toFixed(2)} KB</p>
                    ${chunks.slice(0, 10).map((chunk, i) => formatChunk(chunk, i)).join('')}
                    ${chunks.length > 10 ? '<p>... and ' + (chunks.length - 10) + ' more chunks</p>' : ''}
                `;
            } catch (error) {
                resultsDiv.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            }
        };
    </script>
</body>

</html>